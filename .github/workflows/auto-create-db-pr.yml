name: Auto Create DB Alignment PR

on:
  workflow_dispatch:

jobs:
  create-db-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Create branch chore/db-align-rls
        run: |
          git checkout -b chore/db-align-rls || git checkout chore/db-align-rls

      - name: Verify required files exist
        run: |
          echo "Verifying all required files are present..."
          MISSING_FILES=0
          
          if [ ! -f supabase/migrations/2026-01-03-rls-and-internal-notes.sql ]; then
            echo "ERROR: Migration file missing: supabase/migrations/2026-01-03-rls-and-internal-notes.sql"
            MISSING_FILES=1
          fi
          
          if [ ! -f src/app-fixes/chat-and-notes.ts ]; then
            echo "ERROR: App-fixes file missing: src/app-fixes/chat-and-notes.ts"
            MISSING_FILES=1
          fi
          
          if [ ! -f supabase/functions/_patches/auth-signup-consumeActivationCode.ts ]; then
            echo "ERROR: Auth signup patch missing: supabase/functions/_patches/auth-signup-consumeActivationCode.ts"
            MISSING_FILES=1
          fi
          
          if [ ! -f supabase/functions/_patches/nexus-ai-limits.ts ]; then
            echo "ERROR: Nexus AI limits patch missing: supabase/functions/_patches/nexus-ai-limits.ts"
            MISSING_FILES=1
          fi
          
          if [ ! -f scripts/create-pr.sh ]; then
            echo "ERROR: Create-PR script missing: scripts/create-pr.sh"
            MISSING_FILES=1
          fi
          
          if [ $MISSING_FILES -eq 1 ]; then
            echo "One or more required files are missing. Cannot proceed."
            exit 1
          fi
          
          echo "All required files are present."

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "fix(db+app): migrate internal_notes -> jsonb, add idempotent RLS policies; normalize chat/messages and edge fn safety"
          branch: chore/db-align-rls
          base: master
          title: "fix(db): migrate internal_notes -> jsonb & tighten RLS; normalize chat/messages and edge function safety"
          body: |
            - Adds a safe, non-destructive migration file to migrate `tickets.internal_notes` into structured JSON arrays and idempotent RLS policy creation. The user executed the migration on staging and will run the final ALTER TABLE DROP/RENAME after the code is deployed.
            - Adds app helpers to normalize usage of `chat_messages.message_text` and to parse `internal_notes` robustly.
            - Adds safer Edge Function snippets for atomic activation code consumption and Gemini history limiting + key check.
            - Adds an automation script and a workflow to create the branch/PR locally if needed.

            **Notes for reviewers:**
            - Run the migration on staging and validate `internal_notes_json` content before performing final `ALTER TABLE` DROP/RENAME.
            - Deploy edge functions and application code to staging first. After successful validation, perform final column swap (DROP/RENAME) in staging and then in production.
